<div id="modalAulaUniversal" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm items-center justify-center transition-opacity opacity-0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all scale-95 duration-300 flex flex-col max-h-[90vh]" id="modalAulaContent">
        
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-xl shrink-0">
            <div>
                <h3 id="modalAulaTitle" class="text-xl font-bold text-slate-800">Nova Aula</h3>
                <p id="modalAulaSubtitle" class="text-xs text-slate-500 font-medium">Preencha os detalhes do planejamento abaixo.</p>
            </div>
            <button type="button" onclick="fecharModalAula()" class="p-2 bg-slate-50 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form id="formAula" method="POST" action="" class="flex flex-col overflow-hidden h-full">
            <input type="hidden" name="aula_id" id="input_aula_id">
            
            <div class="p-6 space-y-5 overflow-y-auto custom-scrollbar flex-1">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Turma *</label>
                        <select name="turma_id" id="select_turma" required 
                                class="w-full bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block p-2.5 transition-all outline-none shadow-sm">
                            {% for turma in turmas %}
                            <option value="{{ turma.id }}">{{ turma.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Data *</label>
                        <input type="date" name="data" id="input_data" required 
                               class="w-full bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block p-2.5 transition-all outline-none shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-5">
                    <div class="col-span-3">
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Título / Conteúdo *</label>
                        <input type="text" name="titulo" id="input_titulo" required placeholder="Ex: Introdução à Lógica..." 
                               class="w-full bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block p-2.5 transition-all outline-none shadow-sm placeholder:text-slate-400">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Nº Aula</label>
                        <input type="number" name="numero_aula" id="input_numero_aula" 
                               class="w-full bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block p-2.5 transition-all outline-none shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Status</label>
                        <select name="status" id="select_status" onchange="atualizarCorModal()" 
                                class="w-full bg-slate-50 border border-slate-300 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block p-2.5 transition-all outline-none shadow-sm font-semibold">
                            <option value="Planejando" class="text-blue-600">Planejando</option>
                            <option value="Preparar" class="text-red-600">Preparar</option>
                            <option value="Pronta" class="text-amber-600">Pronta</option>
                            <option value="Entregue" class="text-green-600">Entregue</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Turno</label>
                        <select name="turno" id="select_turno" 
                                class="w-full bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block p-2.5 transition-all outline-none shadow-sm">
                            <option value="Noite">Noite</option>
                            <option value="Manhã">Manhã</option>
                            <option value="Tarde">Tarde</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Professor</label>
                        <select name="ministrante_id" id="select_ministrante" 
                                class="w-full bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block p-2.5 transition-all outline-none shadow-sm">
                            <option value="me">{{ current_user.nome }}</option>
                            {% for prof in professores %}
                            <option value="{{ prof.id }}">{{ prof.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                    <h4 class="text-xs font-bold text-blue-800 uppercase mb-3 flex items-center gap-1">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> Localização
                    </h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Unidade/Prédio</label>
                            <input type="text" name="unidade_predio" id="input_unidade" placeholder="Bloco A" 
                                   class="w-full bg-white border border-slate-300 text-slate-800 text-xs rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-600 p-2 transition-all outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Sala</label>
                            <input type="text" name="sala" id="input_sala" placeholder="302" 
                                   class="w-full bg-white border border-slate-300 text-slate-800 text-xs rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-600 p-2 transition-all outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Bloco Estudo</label>
                            <input type="text" name="bloco_estudo" id="input_bloco" 
                                   class="w-full bg-white border border-slate-300 text-slate-800 text-xs rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-600 p-2 transition-all outline-none">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Descrição Detalhada</label>
                    <textarea name="descricao" id="input_descricao" rows="3" 
                              class="w-full bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block p-2.5 transition-all outline-none shadow-sm resize-none"></textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Observações</label>
                    <input type="text" name="observacoes" id="input_obs" 
                           class="w-full bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block p-2.5 transition-all outline-none shadow-sm">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-1.5">Link Arquivos</label>
                    <div class="flex gap-2 mb-2">
                        <div class="relative flex-1">
                            <i data-lucide="link" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                            <input type="text" name="link_arquivos" id="input_link" placeholder="https://"
                                   class="w-full bg-slate-50 border border-slate-300 text-blue-600 text-sm rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-600 focus:bg-white block pl-9 p-2.5 transition-all outline-none shadow-sm font-medium">
                        </div>
                        <a id="btn_abrir_link" href="#" target="_blank" title="Abrir link em nova guia"
                           class="flex items-center justify-center px-4 bg-slate-100 text-slate-500 rounded-lg border border-slate-200 hover:bg-white hover:text-blue-600 hover:border-blue-200 transition-all min-w-[44px]">
                            <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                    </div>
                    <div id="iframe_link_container" class="hidden rounded-lg border border-slate-200 overflow-hidden bg-slate-50">
                        <p class="text-xs text-slate-500 px-3 py-1.5 bg-slate-100 border-b border-slate-200 flex items-center gap-1">
                            <i data-lucide="globe" class="w-3 h-3"></i> Visualização do link
                        </p>
                        <iframe id="iframe_link_preview" title="Visualização do link" class="w-full border-0 bg-white"
                                style="height: 280px;"></iframe>
                    </div>
                </div>

            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-3 rounded-b-xl shrink-0">
                <button type="button" onclick="fecharModalAula()" class="px-5 py-2.5 text-slate-600 hover:bg-white hover:text-slate-800 border border-transparent hover:border-slate-200 rounded-lg text-sm font-semibold transition-all">Cancelar</button>
                <button type="submit" id="btn_submit_aula" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-200 hover:shadow-blue-300 transition-all flex items-center gap-2 transform active:scale-95">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    <span id="txt_btn_submit">Salvar Planejamento</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Botão do link + iframe: mostra o link dentro do modal quando há URL
    const inputLink = document.getElementById('input_link');
    const btnLink = document.getElementById('btn_abrir_link');
    const iframeContainer = document.getElementById('iframe_link_container');
    const iframePreview = document.getElementById('iframe_link_preview');

    function verificarLink() {
        const url = (inputLink && inputLink.value) ? inputLink.value.trim() : '';
        const fullUrl = url.length > 0 ? (url.startsWith('http') ? url : 'https://' + url) : '';

        if (fullUrl) {
            btnLink.href = fullUrl;
            btnLink.classList.remove('opacity-50', 'pointer-events-none');
            btnLink.title = 'Abrir link em nova guia';
            if (iframeContainer && iframePreview) {
                iframePreview.src = fullUrl;
                iframeContainer.classList.remove('hidden');
            }
        } else {
            btnLink.href = '#';
            btnLink.classList.add('opacity-50', 'pointer-events-none');
            btnLink.title = 'Informe um link no campo ao lado';
            if (iframeContainer && iframePreview) {
                iframePreview.src = 'about:blank';
                iframeContainer.classList.add('hidden');
            }
        }
    }

    if (inputLink) {
        inputLink.addEventListener('input', verificarLink);
    }
</script>
