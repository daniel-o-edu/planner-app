{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8 pb-20">
    
    <div>
        <h2 class="text-2xl font-bold text-slate-800">Configurações</h2>
        <p class="text-slate-500 text-sm">Gerencie seu perfil, colaboradores e dados.</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i data-lucide="user-cog" class="w-5 h-5 text-blue-600"></i> Meus Dados
        </h3>
        
        <form action="{{ url_for('atualizar_perfil') }}" method="POST" class="space-y-4 max-w-lg">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome Completo</label>
                <input type="text" name="nome" value="{{ current_user.nome }}" required class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                <input type="email" name="email" value="{{ current_user.email }}" required class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nova Senha (Opcional)</label>
                <input type="password" name="senha" placeholder="Deixe em branco para manter a atual" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none">
            </div>
            <button type="submit" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-md transition-all">
                Salvar Alterações
            </button>
        </form>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-indigo-600"></i> Professores Adjuntos
        </h3>
        <p class="text-xs text-slate-500 mb-4">Cadastre nomes para selecionar como ministrantes nas suas aulas (substituições).</p>

        <div class="flex flex-wrap gap-2 mb-4">
            {% for prof in professores %}
            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold bg-indigo-50 text-indigo-700 border border-indigo-100">
                {{ prof.nome }}
                <a href="{{ url_for('excluir_professor', id=prof.id) }}" class="hover:text-red-500 ml-1"><i data-lucide="x" class="w-3 h-3"></i></a>
            </span>
            {% else %}
            <span class="text-sm text-slate-400 italic">Nenhum professor cadastrado.</span>
            {% endfor %}
        </div>

        <form action="{{ url_for('adicionar_professor') }}" method="POST" class="flex gap-2 max-w-md">
            <input type="text" name="nome" placeholder="Nome do Professor" required class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-sm flex items-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i> Adicionar
            </button>
        </form>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
            <i data-lucide="database" class="w-5 h-5 text-emerald-600"></i> Gestão de Dados e Backup
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="border border-slate-200 rounded-xl p-5 bg-slate-50/50">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="hard-drive" class="w-5 h-5 text-slate-600"></i>
                    <h4 class="font-bold text-slate-700">Backup Local</h4>
                </div>
                <p class="text-xs text-slate-500 mb-4 h-10">Baixe um arquivo JSON para seu computador. Ideal para guardar cópias físicas.</p>
                
                <a href="{{ url_for('download_backup') }}" class="w-full inline-flex justify-center items-center gap-2 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 px-4 py-2.5 rounded-lg text-sm font-bold transition-all shadow-sm">
                    <i data-lucide="download" class="w-4 h-4"></i> Baixar Arquivo
                </a>
            </div>

            <div class="border border-blue-100 rounded-xl p-5 bg-blue-50/30">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg"><path d="m6.6 66.85 25.3-43.8 25.3 43.8z" fill="#0066da"/><path d="m43.85 23.05 25.3-43.8 25.3 43.8z" fill="#ea4335"/><path d="m6.6 66.85 43.85-76.05 43.85 76.05z" fill="#ffba00"/><path d="m43.85 23.05 25.3 43.8-25.3 43.8z" fill="#00ac47"/><path d="m88.4 68.35h-26.65l-13.6-23.55h-28.7l-13.6 23.55h-5.85c-2.3 0-4.35-1.1-5.6-2.9-1.2-1.75-1.4-4-0.55-6l19.5-33.8 4.25-7.35 15-26h11.7l26.65 46.15c0.85 1.5 0.9 3.25 0.15 4.85-0.75 1.6-2.1 2.75-3.65 2.75z" fill="#2684fc"/><path d="m60.1 5.85 18 31.2 5.35-9.25-16.7-28.95c-0.85-1.5-2.2-2.6-3.8-3.05-1.65-0.5-3.35-0.15-4.75 0.9l-11.45 19.85z" fill="#0066da"/><path d="m66.65 44.8 15 26c0.85 1.45 0.9 3.2 0.15 4.8-0.75 1.6-2.05 2.75-3.65 2.75h-5.85l-19.5-33.8z" fill="#00ac47"/><path d="m43.85 23.05-13.6 23.55-13.6 23.55h28.7z" fill="#00ac47"/><path d="m6.6 66.85h25.3l13.6-23.55-25.3-43.8z" fill="#ffba00"/></svg>
                    <h4 class="font-bold text-slate-700">Google Drive</h4>
                </div>
                <p class="text-xs text-slate-500 mb-4 h-10">Sincronize seus dados com a nuvem. Salve backups ou restaure versões anteriores.</p>
                
                <div class="flex gap-2">
                    <a href="{{ url_for('upload_drive') }}" class="flex-1 inline-flex justify-center items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2.5 rounded-lg text-sm font-bold transition-all shadow-sm">
                        <i data-lucide="cloud-upload" class="w-4 h-4"></i> Salvar
                    </a>
                    <button onclick="abrirModalRestore()" class="flex-1 inline-flex justify-center items-center gap-2 bg-white border border-blue-200 text-blue-700 hover:bg-blue-50 px-3 py-2.5 rounded-lg text-sm font-bold transition-all shadow-sm">
                        <i data-lucide="cloud-download" class="w-4 h-4"></i> Restaurar
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="modalRestore" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4">
        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
            <h3 class="text-lg font-bold text-slate-800">Restaurar do Drive</h3>
            <button onclick="document.getElementById('modalRestore').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <div class="p-5">
            <p class="text-sm text-slate-500 mb-4">Selecione um arquivo abaixo para sincronizar. <br><span class="text-red-500 font-bold">Nota:</span> Dados duplicados serão ignorados, novos dados serão adicionados.</p>
            
            <div id="loadingDrive" class="text-center py-6">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-blue-600"></i>
                <p class="text-xs text-slate-400 mt-2">Buscando backups...</p>
            </div>

            <div id="listaBackups" class="space-y-2 max-h-[300px] overflow-y-auto hidden">
                </div>
        </div>
    </div>
</div>

<script>
    async function abrirModalRestore() {
        document.getElementById('modalRestore').classList.remove('hidden');
        document.getElementById('loadingDrive').classList.remove('hidden');
        document.getElementById('listaBackups').classList.add('hidden');
        
        try {
            const response = await fetch('/backup/drive/list');
            const files = await response.json();
            
            const lista = document.getElementById('listaBackups');
            lista.innerHTML = '';

            if (files.length === 0) {
                lista.innerHTML = '<p class="text-center text-sm text-slate-400 py-4">Nenhum backup encontrado na pasta Planner_Backups.</p>';
            } else {
                files.forEach(file => {
                    // Formata data
                    const date = new Date(file.createdTime).toLocaleString('pt-BR');
                    
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-3 border border-slate-100 rounded-lg hover:bg-slate-50 transition-colors';
                    item.innerHTML = `
                        <div class="flex flex-col overflow-hidden">
                            <span class="font-bold text-sm text-slate-700 truncate">${file.name}</span>
                            <span class="text-[10px] text-slate-400">${date}</span>
                        </div>
                        <a href="/backup/drive/restore/${file.id}" onclick="return confirm('Deseja realmente restaurar este backup?')" class="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded-md font-bold hover:bg-blue-200">
                            Restaurar
                        </a>
                    `;
                    lista.appendChild(item);
                });
            }
            
            document.getElementById('loadingDrive').classList.add('hidden');
            lista.classList.remove('hidden');

        } catch (error) {
            console.error(error);
            alert("Erro ao conectar com Google Drive.");
            document.getElementById('modalRestore').classList.add('hidden');
        }
    }
</script>

{% endblock %}
