{% extends "base.html" %}

{% block content %}

<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
    <div>
        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <i data-lucide="book-open" class="w-6 h-6 text-blue-600"></i>
            Gerenciar Turmas
        </h2>
        <p class="text-slate-500 text-sm mt-1">Cadastre e organize suas disciplinas.</p>
    </div>

    <button onclick="abrirModalCriar()" 
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm transition-all text-sm">
        <i data-lucide="plus" class="w-4 h-4"></i>
        Nova Turma
    </button>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for turma in turmas %}
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all group relative overflow-hidden flex flex-col">
        <div class="absolute left-0 top-0 bottom-0 w-1 {% if turma.ativa %}bg-blue-500{% else %}bg-slate-300{% endif %}"></div>
        
        <div class="p-5 pl-7 flex-1">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-lg text-slate-800 leading-tight">{{ turma.nome }}</h3>
                <span class="text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wide
                    {% if turma.ativa %} bg-green-100 text-green-700 border border-green-200 {% else %} bg-slate-100 text-slate-500 border border-slate-200 {% endif %}">
                    {{ 'Ativa' if turma.ativa else 'Inativa' }}
                </span>
            </div>
            
            <p class="text-xs text-slate-500 uppercase font-semibold mb-4 tracking-wider truncate" title="{{ turma.codigo_completo }}">
                {{ turma.codigo_completo or 'Sem código' }}
            </p>

            <div class="space-y-2 text-sm text-slate-600 mb-2">
                <div class="flex items-center gap-2">
                    <i data-lucide="graduation-cap" class="w-4 h-4 text-slate-400"></i>
                    <span class="truncate">{{ turma.unidade_curricular or 'Matéria Geral' }}</span>
                </div>
                {% if turma.link_diario %}
                <div class="flex items-center gap-2">
                    <i data-lucide="link" class="w-4 h-4 text-slate-400"></i>
                    <a href="{{ turma.link_diario }}" target="_blank" class="text-blue-600 hover:underline truncate">Link do Diário</a>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="px-5 py-3 bg-slate-50 border-t border-slate-100 flex items-center justify-between pl-7">
            <button onclick="abrirModalEditar(
                        '{{ turma.id }}', 
                        '{{ turma.nome }}', 
                        '{{ turma.codigo_completo or '' }}', 
                        '{{ turma.unidade_curricular or '' }}', 
                        '{{ turma.link_diario or '' }}', 
                        '{{ 'true' if turma.ativa else 'false' }}'
                    )" 
                    class="text-sm font-medium text-slate-600 hover:text-blue-600 flex items-center gap-1 transition-colors">
                <i data-lucide="edit-3" class="w-3.5 h-3.5"></i> Editar
            </button>
            
            <a href="{{ url_for('excluir_turma', id=turma.id) }}" 
               onclick="return confirm('ATENÇÃO: Excluir esta turma apagará todas as aulas associadas a ela. Deseja continuar?')"
               class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition-colors" title="Excluir Turma">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </a>
        </div>
    </div>
    {% else %}
    <div class="col-span-full py-12 text-center bg-white rounded-xl border border-dashed border-slate-300">
        <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="book-off" class="w-8 h-8 text-slate-400"></i>
        </div>
        <p class="text-slate-500 font-medium">Nenhuma turma cadastrada ainda.</p>
    </div>
    {% endfor %}
</div>

<div id="modalCriar" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
        
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i> Nova Turma
            </h3>
            <button onclick="document.getElementById('modalCriar').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <form action="{{ url_for('criar_turma') }}" method="POST" class="p-6 space-y-5">
            
            <div class="flex flex-col gap-1.5">
                <label class="text-[11px] font-semibold text-slate-500 uppercase tracking-wide ml-1">Nome Curto da Turma <span class="text-red-500">*</span></label>
                <input type="text" name="nome" required placeholder="Ex: ADS 2025/1" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm font-medium text-slate-800 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="flex flex-col gap-1.5">
                    <label class="text-[11px] font-semibold text-slate-500 uppercase tracking-wide ml-1">Código Oficial</label>
                    <input type="text" name="codigo_completo" placeholder="Ex: T DESI 2025/1 N1-A" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm text-slate-700 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex flex-col gap-1.5">
                    <label class="text-[11px] font-semibold text-slate-500 uppercase tracking-wide ml-1">Unidade Curricular (Matéria)</label>
                    <input type="text" name="unidade_curricular" placeholder="Ex: Desenvolvimento Web" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm text-slate-700 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div class="flex flex-col gap-1.5">
                <label class="text-[11px] font-semibold text-slate-500 uppercase tracking-wide ml-1">Link do Diário Eletrônico</label>
                <div class="relative">
                    <span class="absolute left-3 top-2.5 text-slate-400"><i data-lucide="link" class="w-4 h-4"></i></span>
                    <input type="text" name="link_diario" placeholder="https://..." class="w-full border border-slate-200 rounded-md pl-9 pr-3 py-2 text-sm text-blue-600 underline bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <label class="inline-flex items-center cursor-pointer p-2 rounded-lg hover:bg-slate-50 transition-colors w-full border border-transparent hover:border-slate-100">
                <input type="checkbox" name="ativa" class="sr-only peer" checked>
                <div class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-100 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                <span class="ms-3 text-sm font-medium text-slate-700">Turma Ativa (Visível no Calendário)</span>
            </label>

            <div class="pt-4 flex justify-end gap-3 border-t border-slate-100">
                <button type="button" onclick="document.getElementById('modalCriar').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium transition-colors">Cancelar</button>
                <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-md transition-all">
                    <i data-lucide="save" class="w-4 h-4 inline mr-1"></i> Salvar Turma
                </button>
            </div>
        </form>
    </div>
</div>

<div id="modalEditar" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
        
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="edit" class="w-5 h-5 text-blue-600"></i> Editar Turma
            </h3>
            <button onclick="document.getElementById('modalEditar').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <form action="{{ url_for('editar_turma') }}" method="POST" class="p-6 space-y-5">
            <input type="hidden" name="turma_id" id="edit_id">
            
            <div class="flex flex-col gap-1.5">
                <label class="text-[11px] font-semibold text-slate-500 uppercase tracking-wide ml-1">Nome Curto da Turma <span class="text-red-500">*</span></label>
                <input type="text" name="nome" id="edit_nome" required class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm font-medium text-slate-800 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="flex flex-col gap-1.5">
                    <label class="text-[11px] font-semibold text-slate-500 uppercase tracking-wide ml-1">Código Oficial</label>
                    <input type="text" name="codigo_completo" id="edit_codigo" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm text-slate-700 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex flex-col gap-1.5">
                    <label class="text-[11px] font-semibold text-slate-500 uppercase tracking-wide ml-1">Unidade Curricular</label>
                    <input type="text" name="unidade_curricular" id="edit_uc" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm text-slate-700 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div class="flex flex-col gap-1.5">
                <label class="text-[11px] font-semibold text-slate-500 uppercase tracking-wide ml-1">Link do Diário</label>
                <div class="relative">
                    <span class="absolute left-3 top-2.5 text-slate-400"><i data-lucide="link" class="w-4 h-4"></i></span>
                    <input type="text" name="link_diario" id="edit_link" class="w-full border border-slate-200 rounded-md pl-9 pr-3 py-2 text-sm text-blue-600 underline bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <label class="inline-flex items-center cursor-pointer p-2 rounded-lg hover:bg-slate-50 transition-colors w-full border border-transparent hover:border-slate-100">
                <input type="checkbox" name="ativa" id="edit_ativa" class="sr-only peer">
                <div class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-100 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                <span class="ms-3 text-sm font-medium text-slate-700">Turma Ativa</span>
            </label>

            <div class="pt-4 flex justify-end gap-3 border-t border-slate-100">
                <button type="button" onclick="document.getElementById('modalEditar').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium transition-colors">Cancelar</button>
                <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-md transition-all">
                    <i data-lucide="save" class="w-4 h-4 inline mr-1"></i> Atualizar Turma
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function abrirModalCriar() {
        document.getElementById('modalCriar').classList.remove('hidden');
    }

    // Recebe parâmetros e converte string 'true'/'false' para boolean real do JS
    function abrirModalEditar(id, nome, codigo, uc, link, ativaString) {
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_nome').value = nome;
        document.getElementById('edit_codigo').value = codigo;
        document.getElementById('edit_uc').value = uc;
        document.getElementById('edit_link').value = link;
        
        // CORREÇÃO: Compara strings para setar o checked corretamente
        const isAtiva = (ativaString === 'true');
        document.getElementById('edit_ativa').checked = isAtiva;
        
        document.getElementById('modalEditar').classList.remove('hidden');
    }
</script>

{% endblock %}
